name: Deploy Azure Infrastructure

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set AZURE_CONFIG_DIR (clean cache)
      run: |
        echo "AZURE_CONFIG_DIR=$RUNNER_TEMP/.azure" >> $GITHUB_ENV
        rm -rf "$RUNNER_TEMP/.azure"
        mkdir -p "$RUNNER_TEMP/.azure"

    - name: Azure login via OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Deploy Bicep (Azure CLI)
      run: |
        set -euo pipefail
        suffix="$(date +%s)$(openssl rand -hex 2)"
        sa_name="filmph${suffix}"
        sa_name="${sa_name:0:24}"
        echo "Using storage account name: ${sa_name}"

        az bicep install >/dev/null 2>&1 || true
        az deployment group create \
          --resource-group rg-secure-cloud-native-gallery-dev \
          --template-file infra/main.bicep \
          --parameters storageAccountName="${sa_name}" \
          --verbose
